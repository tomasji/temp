#!/usr/bin/env python3
# Delete tables from database on $CLEARDB_DATABASE_URL (mysql://root:root@localhost/mydb?reconnect=true)
import pymysql.cursors
import re
import os

try:
    db_url = os.environ['CLEARDB_DATABASE_URL']
except:
    print("Error: CLEARDB_DATABASE_URL variable not set")
    exit(1)

(user, password, host, database) = re.search('mysql://([^:]*):([^@]*)@([^/]*)/([^?]*)', db_url).group(1, 2, 3, 4)
db = pymysql.connect(host=host, user=user, password=password, db=database, charset='utf8mb4', cursorclass=pymysql.cursors.DictCursor)
cursor = db.cursor()

cursor.execute("DROP PROCEDURE IF EXISTS drop_all_tables")
cursor.execute("""
CREATE PROCEDURE drop_all_tables()
BEGIN
    DECLARE _done INT DEFAULT FALSE;
    DECLARE _tableName VARCHAR(255);
    DECLARE _cursor CURSOR FOR
        SELECT table_name 
        FROM information_schema.TABLES
        WHERE table_schema = SCHEMA();
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET _done = TRUE;

    SET FOREIGN_KEY_CHECKS = 0;

    OPEN _cursor;

    REPEAT FETCH _cursor INTO _tableName;

    IF NOT _done THEN
        SET @stmt_sql = CONCAT('DROP TABLE ', _tableName);
        PREPARE stmt1 FROM @stmt_sql;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
    END IF;

    UNTIL _done END REPEAT;

    CLOSE _cursor;
    SET FOREIGN_KEY_CHECKS = 1;
END
""")
cursor.callproc("drop_all_tables")
db.close()

